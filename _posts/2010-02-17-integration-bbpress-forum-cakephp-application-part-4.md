---
layout: post
title: "Integration of a bbPress forum into a cakePHP application (part 4)"
custom_v2_id: 49
---

<p>We're almost done. There is just one last thing we must do. We don't want our dear user to have to login twice, once for the main app and once for the form, do we ?</p>
<h4>Creating the Configure keys</h4>
<p>So first, go back to your <code>bb-config.php</code> file and if you haven't already, define the <code>BB_AUTH_KEY</code> and <code>BB_LOGGED_IN_KEY</code>.</p>
<p>Go to your <code>app/config/bootstrap.php</code> and create entries in <code>Configure </code>for this same keys. I named mine <code>bbPress.authKey</code> and <code>bbPress.logKey</code>.</p>
<p>Now, go back to your database, open the <code>bb_meta</code> table and find the <code>bb_auth_salt</code> and <code>bb_loggued_in_salt</code> values. Copy them to two more <code>Configure </code>keys (<code>bbPress.authSalt</code> and <code>bbPress.logSalt</code>).</p>
<p>One last key to create. Head back to <code>bb-config.php</code> and add the following line :</p>
<pre lang="php"><code lang="php">define('BB_HASH', 'XXXXX');</code></pre>
<p>Of course, set <code>XXXX</code> to a unique string. The name of your website should suffice, it is just used to differenciate between cookies on the same domain. Report the same value in <code>Configure</code> : <code>bbPress.hash</code>.</p>
<h4>Creating the cookies</h4>
<p>You're now ready to create bbPress cookies. bbPress will need to create two different sets of cookie.</p>
<p>A bbPress cookie contain a value formatted like : <code>&lt;login&gt;|&lt;expiration&gt;|&lt;hash&gt;</code></p>
<p>The hash is based on the user password, login, expiration and several other keys. It also involve double hashing of the value, with different salt and key values.</p>
<p>I've eased the pain of understanding how to create a cookie value, just use the following function :</p>
<pre lang="php"><code lang="php">function __getCookieValue($options = array()) {<br />	 // We will need the login, pass and expiration date to create the cookie<br />	 $userLogin = $options['name']; // The user login<br />	 $userPass = $options['password']; // The password encrypted in the database<br />	 $userPassFragment = substr($userPass, 8, 4);    // We will take only a small part of the password<br />	 $expiration = $options['expiration'];<br />	 $data = $userLogin.$userPassFragment."|".$expiration;    // The main data that will be used create the final hash<br /><br />	 // We first get a first hash key that we will use to generate a second one<br />	 $firstKey = hash_hmac('md5', $data, $options['salt']);<br />	 // Then we create the final hash saved in the cookie<br />	 $finalHash = hash_hmac('md5', $userLogin.'|'.$expiration, $firstKey);<br /><br />	 // The final data to store in the cookie<br />	 return $userLogin."|".$expiration."|".$finalHash;<br /><br /> }<br /></code></pre>
<p>You should pass to this function an array containing a name, password and expiration date. The password should be exactly as it is stored in the database.</p>
<p>You should also pass a 4th value, named salt, that is different depending of the type of cookie you're trying to create. For a auth cookie, use <code>Configure::read('bbPress.authKey').Configure::read('bbPress.authSalt')</code> and for a log cookie, use <code>Configure::read('bbPress.logKey').Configure::read('bbPress.logSalt')</code>.</p>
<p>You will need to create two log cookies (for <code>/</code> and <code>/forum/</code>) and three auth cookies (for <code>/forum/bb-admin</code>,<code> /forum/bb-plugins</code> and <code>/forum/my-plugins</code>).</p>
<p>Here is the complete method for creating all these cookies. Just call it in your app whenever your want to log the current user to the forum. Just feed it a user and password.</p>
<pre lang="php"><code lang="php">/**<br /> *    createCookies<br /> *    Create the cookies that can be used to connect to the bbPress forum<br /> *    bbPress does a lot of complicating stuff with hashing when creating its cookie. We replicate it here<br /> *<br /> *    The content of the cookie is formed in the format username|expirationDate|hash<br /> *<br /> *    The hash part is the most difficult, it involve double hashing based on various salt and values<br /> **/<br /> function createCookies($name, $pass) {<br />	 $expirationDate = time() + 1209600; // When the cookie should stop working (2 weeks)<br /><br />	 // Getting the log in salt<br />	 $completeSalt = Configure::read('bbPress.logKey').Configure::read('bbPress.logSalt');<br />	 // The log in cookie name<br />	 $cookieName = "bbpress_logged_in_".Configure::read('bbPress.hash');<br />	 // Getting the value<br />	 $cookieValue = __getCookieValue(array(<br />		 'name' =&gt; $name,<br />		 'password' =&gt; $pass,<br />		 'salt' =&gt; $completeSalt,<br />		 'expiration' =&gt; $expirationDate<br />	 ));<br />	 // Setting the cookie for the correct path<br />	 setcookie($cookieName, $cookieValue, $expirationDate, "/", false, false, true);<br />	 setcookie($cookieName, $cookieValue, $expirationDate, "/forum/", false, false, true);<br /><br /><br /><br />	 // Getting the auth salt<br />	 $completeSalt = Configure::read('bbPress.authKey').Configure::read('bbPress.authSalt');<br />	 // The auth cookie name<br />	 $cookieName = "bbpress_".Configure::read('bbPress.hash');<br />	 // Getting the value<br />	 $cookieValue = __getCookieValue(array(<br />		 'name' =&gt; $name,<br />		 'password' =&gt; $pass,<br />		 'salt' =&gt; $completeSalt,<br />		 'expiration' =&gt; $expirationDate<br />	 ));<br />	 // Setting the cookie for the correct path<br />	 setcookie($cookieName, $cookieValue, $expirationDate, '/forum/bb-admin', false, false, true);<br />	 setcookie($cookieName, $cookieValue, $expirationDate, '/forum/bb-plugins', false, false, true);<br />	 setcookie($cookieName, $cookieValue, $expirationDate, '/forum/my-plugins', false, false, true);<br /> }</code></pre>
<p>And for logging out, just delete the cookies :</p>
<pre lang="php"><code lang="php">function clearCookies() {<br />	 // The name of the cookie to delete<br />	 $cookieName = "bbpress_logged_in_".Configure::read('bbPress.hash');<br />	 setcookie($cookieName, "", time()-3600, "/", false, false, true);<br />	 setcookie($cookieName, "", time()-3600, "/forum/", false, false, true);<br />	 // The auth cookie name<br />	 $cookieName = "bbpress_".Configure::read('bbPress.hash');<br />	 setcookie($cookieName, "", time()-3600, '/forum/bb-admin', false, false, true);<br />	 setcookie($cookieName, "", time()-3600, '/forum/bb-plugins', false, false, true);<br />	 setcookie($cookieName, "", time()-3600, '/forum/my-plugins', false, false, true);<br /> }</code></pre>
<p>Hope all that helps ! It took some time to put all this together but I hope it could help other bakers out there.</p>
<h4>Downloading</h4>
<p>For anyone interested, here is a link to download all the files : http://www.pixelastic.com/download/bbpress.rar</p>
<p>Note that it can't be used as-is because it involves a bbPress install, a custom Authentication system and also because I wrote it as part of a bigger plugin.</p>
<p>So, feel free to browse the files and get what you need, but consider it as a part of a bigger app, so you'll have to re-plug what's missing.</p>