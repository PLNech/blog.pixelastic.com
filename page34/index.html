<!doctype html>
<html class="no-js" lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>
     Pixelastic 
  </title>
  <meta name="description" content="Personal blog of Tim Carry. Posting mostly on tech-related stuff.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/forms.css">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

<body class="layout-reverse theme-base-0b">
  <div class="sidebar">
    <div class="container">
      <div class="sidebar-about">
        <h1><a href="/index.html">Pixelastic</a></h1>
        <p class="lead">Personal blog of Tim Carry. Posting mostly on tech-related stuff.</p>
      </div>

      <ul class="sidebar-nav">
        <li class="sidebar-nav-item active">
          <a href="/">Home</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/about/">About</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/archive/">Archive</a>
        </li>
      </ul>
      <div class="sidebar-footer">Website code available on <a href="https://github.com/pixelastic/blog.pixelastic.com">GitHub</a></div>
    </div>
  </div>

  <div class="content container">
    <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/05/11/using-custom-find-and-paginate-methods-in-cakephp-1-3/">
        Using custom find and paginate methods in cakePHP 1.3
      </a>
    </h1>

    <span class="post-date">11 May 2010</span>

    <p>For the blog plugin I&#39;m writing I needed a way to fetch only blog posts that
were actually published. I didn&#39;t want to write the find conditions every time
I had to make a request so I tried to define a custom find method.</p>

<p>I remember having read something about that a while ago, in a blog or in a
changelog and so I thought it will be quite easy to implement using some cake
automagic.</p>

<p>It was not that easy, I had to override two core methods in my <code>AppModel</code>, but
here the result :</p>

<h2>Using custom find methods</h2>

<p>I wanted to be able to call my custom method writing
<code>$this-&gt;Post-&gt;find(&#39;published&#39;)</code> so I created a <code>__findPublished()</code> method in
my Post model.</p>

<p>It basically returns a <code>find(&#39;all&#39;)</code> with custom conditions.</p>

<p>I then edited my AppModel file to hook on the default <code>find()</code> method :</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">function find($type, $options = array(), $order = null, $recursive = null) {</span>
<span class="x">  $methodName = &#39;__find&#39;.ucfirst($type);</span>
<span class="x">  // Using default method if not defined</span>
<span class="x">  if (!method_exists($this, $methodName)) {</span>
<span class="x">    // We force default fields and order keys or we could run into trouble for undefined index</span>
<span class="x">    $options = Set::merge(array(&#39;fields&#39; =&gt; array(), &#39;order&#39; =&gt; array()), $options);</span>
<span class="x">    return parent::find($type, $options, $order, $recursive);</span>
<span class="x">  }</span>
<span class="x">  // Using custom method</span>
<span class="x">  return $this-&gt;{$methodName}($options, $order, $recursive);</span>
<span class="x">}</span>
</code></pre></div>
<p>(Note that there may still be some issues with this method, especially if the
$type parameter is not a string. I&#39;m always using the <code>find()</code> method with a
string as first argument but maybe you&#39;re not, or the core still use the old
implementation.)</p>

<p>Anyway, what it does is testing if a <code>__findSomething()</code> method is defined,
and if it is it returns its results, otherwise it just delegates to the
default <code>find()</code> method.</p>

<h2>Using custom find methods in paginate</h2>

<p>So far, so good. But now how do you tell cake to use this custom find when
paginating stuff ? The first part is easy (but required some digging into the
core code). It appears that if the zero key of the <code>$paginate</code> var is set to a
string, this will be used as the find type.</p>

<p>One easy way to do this is calling <code>array_unshift($this-&gt;paginate,
&#39;published&#39;)</code> just before the <code>$this-&gt;paginate(&#39;Post&#39;)</code> call in the
controller.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">// Getting the paginated post list</span>
<span class="x">array_unshift($this-&gt;paginate, &#39;published&#39;);</span>
<span class="x">$itemList = $this-&gt;paginate($this-&gt;model);</span>
<span class="x">$this-&gt;set(&#39;itemList&#39;, $itemList);</span>
</code></pre></div>
<p>You&#39;ll notice that your custom find method is used for the pagination. What
you may not notice at first sight is that the total count of results is not
correct. Cake still uses the default <code>find(&#39;count&#39;)</code> without using the custom
method.</p>

<p>We will now need to create a <code>__paginateCountPublished()</code> method in our <code>Post
</code>model that will return the total count of posts to paginate.</p>

<p>Forcing Cake to do what we want is a little trickier this time. We will need
to create a <code>paginateCount()</code> method in our <code>AppModel</code>. If such a method
exists for a given model, Cake will use it instead of the default
<code>find(&#39;count&#39;)</code> when paginating results. By creating it in the <code>AppModel</code>we
make sure that all the paginate counts use it.</p>

<p>This method takes a third argument called $extra which will contain our custom
find name. If set, we will return the custom paginate count. If not set, we
revert to the default way of calculating the total count (copy/pasted from the
core).</p>

<p>So, here the <code>paginateCount()</code> method to add to your <code>AppModel</code>:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">function paginateCount($conditions = array(), $recursive = null, $extra = array()) {</span>
<span class="x">  // If no custom find specified, we return the default count</span>
<span class="x">  if (empty($extra[&#39;type&#39;])) {</span>
<span class="x">      $parameters = compact(&#39;conditions&#39;);</span>
<span class="x">      if ($recursive != $this-&gt;recursive) {</span>
<span class="x">          $parameters[&#39;recursive&#39;] = $recursive;</span>
<span class="x">      }</span>
<span class="x">      return $this-&gt;find(&#39;count&#39;, array_merge($parameters, $extra));</span>
<span class="x">  }</span>

<span class="x">  // We return the __paginateCountSomething</span>
<span class="x">  $methodName = &#39;__paginateCount&#39;.ucfirst($extra[&#39;type&#39;]);</span>
<span class="x">  return $this-&gt;{$methodName}($conditions, $recursive, $extra);</span>
<span class="x">    }</span>
</code></pre></div>
<p>And don&#39;t forget to create a<code>__paginateCountPublished($conditions = array(),
$recursive = null, $extra = array())</code> method in your <code>Post</code>model</p>

<h2>And you&#39;re done</h2>

<p>You can now do some <code>$this-&gt;Post-&gt;find(&#39;published&#39;)</code> magic in your controller.
And don&#39;t forget the <code>array_unshift()</code> tip to use the custom find in a
paginate call, it have to be the first key.</p>


    <div class="tag-list">
      
        <a href="/tags/php">#php</a>
      
        <a href="/tags/paginate">#paginate</a>
      
        <a href="/tags/paginatecount">#paginatecount</a>
      
        <a href="/tags/custom-find">#custom-find</a>
      
        <a href="/tags/cakephp">#cakephp</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/05/11/gzipping-your-font-files/">
        Gzipping your font files
      </a>
    </h1>

    <span class="post-date">11 May 2010</span>

    <p>When using <code>@font-face</code> to display fonts, you have to create a whole bunch of
font files on your server to accomodate the quirks of the various browsers.</p>

<p>If you do things right (or follow the automatic kit build of FontSquirell),
you should get a <code>.eot</code> file for IE, a <code>.ttf</code>/<code>.otf</code> file for current
browsers, a <code>.svg</code> file for Chrome and the iPhone/iPad and a <code>.woff</code> file for
the next browser generation.</p>

<p>Unfortunatly, you&#39;ll have to cope with that because there isn&#39;t much we can do
about it at the moment.</p>

<p>But you can compress those files to make the font rendering faster. Some
browsers even download all the fonts even if they will only use one, so
compress them !</p>

<p>The easiest way is to configure your server to automatically gzip them. You
should already have done that for your css and js file so it is just a matter
of adding new types.</p>

<p>As far as I know <code>.otf</code> and <code>.ttf</code> files don&#39;t have registered mimetype, so I
had to create a dummy one for them in my .htaccess :</p>
<div class="highlight"><pre><code class="language-apache" data-lang="apache"><span class="nb">AddType</span> x-font/otf    .otf
<span class="nb">AddType</span> x-font/ttf    .ttf
<span class="nb">AddType</span> x-font/eot    .eot
</code></pre></div>
<p>I also added the <code>.eot</code> because even if an <code>application/vnd.ms-fontobject</code>
mimetype is registered for this obscure microsoft format, when I tried to add
a deflate rule on it, my Apache crashed so I took the safest way of defining a
custom mimetype.</p>

<p>I prefixed them with an <code>x-</code>to make sure that it won&#39;t mess with existing
mimetypes.</p>

<p>The second part was to add gziping to those</p>
<div class="highlight"><pre><code class="language-apache" data-lang="apache"><span class="nb">AddOutputFilterByType</span> DEFLATE x-font/otf x-font/ttf x-font/eot
</code></pre></div>
<p>SVG files are in fact xml files, and you should already have them gzipped, so
no need to add them here.</p>

<p>I haven&#39;t included <code>.woff</code> files because <code>.woff</code> files are already compressed
files, so you don&#39;t need to gzip them.</p>


    <div class="tag-list">
      
        <a href="/tags/woff">#woff</a>
      
        <a href="/tags/ttf">#ttf</a>
      
        <a href="/tags/otf">#otf</a>
      
        <a href="/tags/mod_deflate">#mod_deflate</a>
      
        <a href="/tags/gzip">#gzip</a>
      
        <a href="/tags/font">#font</a>
      
        <a href="/tags/eot">#eot</a>
      
        <a href="/tags/apache">#apache</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/05/11/give-your-variables-meaningful-names/">
        Give your variables meaningful names
      </a>
    </h1>

    <span class="post-date">11 May 2010</span>

    <p>I just realized that the fullscreen plugin I was using with tinyMCE (v3.3.5)
was throwing an error in my Firebug panel everytime I closed it.</p>

<p>As I wrote some tinyMCE plugins myself I thought I may have done something
that was causing this. So I opened up the javascript file and checked for the
error line :</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">de</span> <span class="o">=</span> <span class="nx">DOM</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_is_enabled&#39;</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_new_window&#39;</span><span class="p">))</span>
    <span class="nx">closeFullscreen</span><span class="p">();</span> <span class="c1">// Call to close in new window</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">DOM</span><span class="p">.</span><span class="nx">win</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">tinymce</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">Event</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">win</span><span class="p">,</span> <span class="s1">&#39;resize&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">resizeFunc</span><span class="p">);</span>
  <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="nx">tinyMCE</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_editor_id&#39;</span><span class="p">)).</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">ed</span><span class="p">.</span><span class="nx">getContent</span><span class="p">({</span><span class="nx">format</span> <span class="o">:</span> <span class="s1">&#39;raw&#39;</span><span class="p">}),</span> <span class="p">{</span><span class="nx">format</span> <span class="o">:</span> <span class="s1">&#39;raw&#39;</span><span class="p">});</span>
  <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="nx">tinyMCE</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">ed</span><span class="p">);</span>
  <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="nx">DOM</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;mce_fullscreen_container&#39;</span><span class="p">);</span>
  <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="nx">ed</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">=</span> <span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_html_overflow&#39;</span><span class="p">);</span>
  <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="nx">DOM</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="s1">&#39;overflow&#39;</span><span class="p">,</span> <span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_overflow&#39;</span><span class="p">));</span>
  <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="nx">DOM</span><span class="p">.</span><span class="nx">win</span><span class="p">.</span><span class="nx">scrollTo</span><span class="p">(</span><span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_scrollx&#39;</span><span class="p">),</span> <span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_scrolly&#39;</span><span class="p">));</span>
  <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="err">   </span> <span class="nx">tinyMCE</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="nx">tinyMCE</span><span class="p">.</span><span class="nx">oldSettings</span><span class="p">;</span> <span class="c1">// Restore old settings</span>
    <span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">}</span>
<span class="err">   </span> <span class="err">   </span> <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>If you&#39;re not familiar with the complex tinyMCE syntax this may seems a
little... well... complex.  I&#39;ll focus on the error line but I wanted to paste
the whole code block so you can see my point.</p>

<p>The error line is this one :</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">ed</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">=</span> <span class="nx">ed</span><span class="p">.</span><span class="nx">getParam</span><span class="p">(</span><span class="s1">&#39;fullscreen_html_overflow&#39;</span><span class="p">);</span>
</code></pre></div>
<p>Of course it will throw an error, we try to access a property of an element we
just removed from the DOM (two lines before : <code>tinyMCE.remove(ed);</code>). Why
would someone want to do that ?</p>

<p>Well in fact, this is not <code>ed</code> (that we should try to access, but <code>de</code> (short
for <code>DOM.doc.documentElement</code>). In fact the code was correct in 3.3.2, but
someone changed it around 3.3.3.</p>

<p>My guess is that someone had the file opened, saw this bit of code, spotted
the <code>de</code>, and seeing a lot of references to <code>ed</code> all around, thought it was a
typo and &#39;fixed&#39; it.</p>

<p>Reading the tinyMCE code (whenever you want to understand how it works, or
want to study plugins before creating your own) is pretty hard. There are
almost no comments, and variable names are only one or two letters long.</p>

<p>The tinyMCE team released a survey asking user what should be improved on the
tinyMCE product. I answered it, and my main point was to improve
documentation, because reading the tinyMCE core to understand its inner goings
is quite a chore.</p>


    <div class="tag-list">
      
        <a href="/tags/variables">#variables</a>
      
        <a href="/tags/tinymce">#tinymce</a>
      
        <a href="/tags/javascript">#javascript</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/05/07/csstidy-and-the-woff-fonts/">
        @font-face with multiple fonts and CSSTidy
      </a>
    </h1>

    <span class="post-date">07 May 2010</span>

    <p>The <code>.woff</code> font extension is the standard-to-go in terms of font embedding on
the web.</p>

<p>You should add them first in the order of fonts you&#39;re loading, before the
<code>.ttf</code>/<code>.otf</code> ones.</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span class="k">@font-face</span> <span class="p">{</span>
  <span class="nt">font-family</span><span class="o">:</span> <span class="s2">&quot;Unibody8SmallCaps Regular&quot;</span><span class="o">;</span>
  <span class="nt">src</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;fonts/unibody_8-smallcaps-webfont.woff&#39;</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;woff&#39;</span><span class="o">),</span> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;fonts/unibody_8-smallcaps-webfont.ttf&#39;</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;truetype&#39;</span><span class="o">);</span>
<span class="p">}</span>
</code></pre></div>
<p>The interesting thing to note is that you cannot omit the quotes around the
<code>format(&#39;woff&#39;)</code>/<code>format(&#39;truetype&#39;)</code> part. Otherwise the font won&#39;t be
recognized (at least by FF3.6).</p>

<p>CSSTidy seems to have a bug when there are multiple <code>format()</code>declarations in
a rule, it removes quotes in each of them except the last one, thus making the
whole rule unparsable by the browser.</p>

<p>So I started, again, to dig into the CSSTidy code and see what I could do
about that.</p>

<p>I updated the <code>csstidy.php</code> file at around line 847 and changed the <code>if</code>
statement to look like this :</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if($this-&gt;sub_value != &#39;&#39;) {</span>
<span class="x">  $this-&gt;sub_value_arr[] = $this-&gt;sub_value;</span>
<span class="x">  foreach($this-&gt;sub_value_arr as &amp;$sub_value) {</span>
<span class="x">    if (substr($sub_value, 0, 6) == &#39;format&#39;) {</span>
<span class="x">      $sub_value = str_replace(array(&#39;format(&#39;, &#39;)&#39;), array(&#39;format(&quot;&#39;, &#39;&quot;)&#39;), $sub_value);</span>
<span class="x">    }</span>
<span class="x">  }</span>
<span class="x">  $this-&gt;sub_value = &#39;&#39;;</span>
<span class="x">}</span>
</code></pre></div>
<p>This way all sub values of the <code>src:</code> rule will be correctly parsed, and not
only the last one.</p>


    <div class="tag-list">
      
        <a href="/tags/font-face">#font-face</a>
      
        <a href="/tags/woff">#woff</a>
      
        <a href="/tags/format">#format</a>
      
        <a href="/tags/csstidy">#csstidy</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/05/05/preventing-firefox-from-auto-filling-login-and-password-fields/">
        Preventing Firefox from auto-filling login and password fields
      </a>
    </h1>

    <span class="post-date">05 May 2010</span>

    <p>When you login in an app and tell Firefox to remember your password, it will
then automatically fill any password field that have a login field near it.</p>

<p>It can be quite embarassing when you are developping an admin panel where you
can edit your own profile informations. The password field will be filled
every time you go to that page, even if you explicitly set no value.</p>

<p>The way to circumvent this is to add an <code>autocomplete=&quot;off&quot;</code> attribute to the
field.</p>

<p>It may not validate, but is understood both by IE and FF AFAIK.</p>


    <div class="tag-list">
      
        <a href="/tags/ie">#ie</a>
      
        <a href="/tags/firefox">#firefox</a>
      
        <a href="/tags/jquery-autocomplete">#jquery-autocomplete</a>
      
    </div>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page35">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page33">Newer</a>
    
  
</div>

  </div>

</body>

</html>
