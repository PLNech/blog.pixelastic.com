<!doctype html>
<html class="no-js" lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>
     Pixelastic 
  </title>
  <meta name="description" content="Personal blog of Tim Carry. Posting mostly on tech-related stuff.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/forms.css">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

<body class="layout-reverse theme-base-0b">
  <div class="sidebar">
    <div class="container">
      <div class="sidebar-about">
        <h1><a href="/index.html">Pixelastic</a></h1>
        <p class="lead">Personal blog of Tim Carry. Posting mostly on tech-related stuff.</p>
      </div>

      <ul class="sidebar-nav">
        <li class="sidebar-nav-item active">
          <a href="/">Home</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/about/">About</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/archive/">Archive</a>
        </li>
      </ul>
      <div class="sidebar-footer">Website code available on <a href="https://github.com/pixelastic/blog.pixelastic.com">GitHub</a></div>
    </div>
  </div>

  <div class="content container">
    <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/10/11/preventing-tinymce-wrapping-img/">
        Preventing tinyMCE from wrapping &lt;img /&gt; in &lt;p&gt;
      </a>
    </h1>

    <span class="post-date">11 Oct 2010</span>

    <p>If you just want to add a presentational image in a tinyMCE editor, you&#39;ll
find out very quickly that it will be wrapped in <code>&lt;p&gt;&lt;/p&gt;</code> without you asking.</p>

<p>The question has been asked several times on the tinyMCE forums, but the
answers never quite satisfied me. It ranges from the classical &quot;<em>Why do you
want to do this ? You should better use <code>&lt;insert semantic element and css
here&gt;</code></em>&quot; to &quot;<em>Just do a regexp before displaying your content to remove the bad
<code>&lt;p&gt;...&lt;/p&gt;</code></em>&quot;.</p>

<p>This clearly did not satisfy me.</p>

<p>The solution was to define the<code>forced_root_block</code> setting value to <code>false</code>,
allowing us to create any element on the top level, and not having it
automatically wrapped in <code>&lt;p&gt;.</code></p>

<h2>Fixing the side effect</h2>

<p>Allowing for elements to be input directly in the root level has the nasty
side effect of creating tinyMCE editor instances with a default text of, well,
nothing, instead of the really usefull <code>&lt;p&gt;</code> tag. Also, if you do a Ctrl+A and
delete all content, you&#39;ll end up with an empty editor without the initial
<code>&lt;p&gt;</code> tags</p>

<p>To fix this part, I just added an <code>onNodeChange</code>event to fire every time the
content is changed. I test the current content and if empty add the <code>&lt;p&gt;</code> tag.
There is a little subtelty though, to correctly place the caret where needed.</p>

<p>In your <code>tinyMCE.init</code> call, just add the following setup key :</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">tinyMCE</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
<span class="p">[...]</span>
  <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">editor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">editor</span><span class="p">.</span><span class="nx">onNodeChange</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">editor</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">editorContent</span> <span class="o">=</span> <span class="nx">editor</span><span class="p">.</span><span class="nx">getContent</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">editorContent</span><span class="o">===</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We set content as a &lt;p&gt; containing a placeholder, then we delete the placeholder to place the caret</span>
        <span class="nx">editor</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;&lt;span id=&quot;__CaretPlacholder&quot;&gt;Placeholder&lt;/span&gt;&lt;/p&gt;&#39;</span><span class="p">);</span>
        <span class="nx">editor</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">editor</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;#__CaretPlacholder&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">editor</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">editor</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;#__CaretPlacholder&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">});</span>
   <span class="p">}),</span>
<span class="p">[...]</span>
 <span class="p">});</span>
</code></pre></div>
<p>Before finding this solution, I tried the <code>onBeforeSetContent</code>callback, but
due to a bug in the tinyMCE source, it couldn&#39;t handle well the case where the
editor is empty. So I had to resort to a more generic callback.</p>


    <div class="tag-list">
      
        <a href="/tags/onbeforesetcontent">#onbeforesetcontent</a>
      
        <a href="/tags/oninit">#oninit</a>
      
        <a href="/tags/tinymce">#tinymce</a>
      
        <a href="/tags/javascript">#javascript</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/10/11/displaying-html-mails-sent-from-cakephp-in-squirrelmail/">
        Displaying HTML mails sent from cakePHP in SquirrelMail
      </a>
    </h1>

    <span class="post-date">11 Oct 2010</span>

    <p>I just stumble upon the fact that my automated multipart (text + html) mails
sent from my apps weren&#39;t correctly displayed on SquirrelMail.</p>

<p>I&#39;m personnaly using GMail for my day to day email needs, but one of my client
was using the default <a href="http://squirrelmail.org/">SquirrelMail</a> (v1.4.21)
install on their <a href="http://www.dreamhost.com/">Dreamhost account</a>. The received
mails are not correctly parsed and get displayed as plain text, even if the
header clearly specifiy a <code>Content-Type: multipart/alternative;
boundary=&quot;alt-&quot;</code></p>

<p>The first culprit was that no boundary were given. This does not seem to cause
GMail any problem, but I thought that SquirrelMail may choke on that. So I
manually added a <code>$this-&gt;Email-&gt;_createboundary();</code> call before my
<code>$this-&gt;Email-&gt;send();</code></p>

<p>Still, no succes. After some googling I found a <a href="http://cakephp.lighthouseapp.com/projects/42648-cakephp/tickets/14%0A-email-component-should-set-mime-version-header-when-sendas-html-or-both">bug
report</a> for
a similar problem. I tried adding the suggested MIME header, and that solved
my problem.</p>

<p>So here&#39;s my updated code :</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$this-&gt;Email-&gt;sendAs = &#39;both&#39;;</span>
<span class="x">$this-&gt;Email-&gt;_createboundary();</span>
<span class="x">$this-&gt;Email-&gt;__header[] = &#39;MIME-Version: 1.0&#39;;</span>
<span class="x">$this-&gt;Email-&gt;send();</span>
</code></pre></div>
<p>I&#39;ll now have to add those two additional line of code everytime I&#39;ll have to
send a multipart (html + text) email in cakePHP, until it get fixed (no
specified milestone).</p>


    <div class="tag-list">
      
        <a href="/tags/cakephp">#cakephp</a>
      
        <a href="/tags/mail">#mail</a>
      
        <a href="/tags/squirrelmail">#squirrelmail</a>
      
        <a href="/tags/webmail">#webmail</a>
      
        <a href="/tags/headers">#headers</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/10/06/aborting-an-ajax-request-with-jquery/">
        Aborting an AJAX request with jQuery
      </a>
    </h1>

    <span class="post-date">06 Oct 2010</span>

    <p>I needed a way to abort a pending AJAX request. I had a dialog box loaded
through AJAX, but I let my users the possibility to close the window before it
was completely loaded.</p>

<p>I thought I could easily cancel a request using jQuery but it appears that
there is no method to do that. I had to instead directly call the <code>.abort()</code>
method on the XHR object returned by <code>$.ajax</code>.</p>

<p>What I learned was that aborting an XHR request still triggered the jQuery
ajax <code>complete</code>callback, and even passed a <code>success</code> as second argument.</p>

<p>My complete callback was supposed to display the loaded window, so I really
didn&#39;t want it to fire if the user closed the loading window.</p>

<p>I finally had to check on the <code>XHR.status</code> property (200 if ok, 0 if aborted)
to manually stop the <code>complete</code>callback.</p>

<p>It felt surprising at first that an abort call is not intercepted as an error,
but after a little more thinking, it is logical. An abort is something that
the user asked for, so it shouldn&#39;t be considered an error (which is something
that no one ever asked for).</p>

<p>On the other hand, it feels strange to consider an abort as a success too. I
guess the jQuery team didn&#39;t have a lot of request for an edge case like abort
and didn&#39;t wrap their API around it, leaving us with the low level XHR object
instead.</p>


    <div class="tag-list">
      
        <a href="/tags/javascript">#javascript</a>
      
        <a href="/tags/jquery">#jquery</a>
      
        <a href="/tags/xhr">#xhr</a>
      
        <a href="/tags/ajax">#ajax</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/10/05/openid-redirect-not-working-on-opera/">
        Openid redirect not working on Opera
      </a>
    </h1>

    <span class="post-date">05 Oct 2010</span>

    <p>I had a hard time firguring out while my openId login method does not work
correctly with Opera.</p>

<p>I either ended up on the redirect page forever, or did not get redirected back
to my website after Google check, or finally even get blackholed back on my
own site.</p>

<p>I only occured with Opera.</p>

<p>I&#39;ve read on various places that the security settings of Opera are made to
prevent an automatic redirect to a website to be able to write cookie. This is
a fair defense, but it does break the whole openId concept. Or at least my
implementation.</p>

<p>Some sites manages to get it to work, even on Opera (stackoverflow for
example).</p>

<p>I&#39;ll hide the openId login method for my Opera users until this is fixed or I
find a solution.</p>


    <div class="tag-list">
      
        <a href="/tags/google">#google</a>
      
        <a href="/tags/openid">#openid</a>
      
        <a href="/tags/opera">#opera</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/10/05/copy-paste-text-from-word-into-tinymce/">
        Copy/Paste text from Word into tinyMCE
      </a>
    </h1>

    <span class="post-date">05 Oct 2010</span>

    <p>What good is building a really nice CMS with top-notch WYSIWYG editor if you
handed it to clients that will blindly copy/paste Word documents into it ?</p>

<p>Well, it will just render a big ugly mess of proprietary and contradictory
pseudo-css rules. You could even be blamed for it.</p>

<h2>The solution</h2>

<p>The latest versions of tinyMCE came bundled with an improved <code>paste</code>plugin.
It will automatically attempt to clean bad pasted text by operating some dark
voodoo magic on it.</p>

<p>It does it quite well to be honest, removing almost all messy formatting. From
the tests I tried, I was still getting useless crap in the resulting text (CSS
comments, <code>&lt;span&gt;</code> with overly long style of color and background-color
definitions, etc).</p>

<p>I finally decided to take a more brutal approach. The <code>paste</code>plugin contained
a <code>_insertPlainText</code> method that was supposed to be used in conjunction with a
toolbar icon.</p>

<p>This method removes all formatting. Period.</p>

<p>As I didn&#39;t want to have to click on a toolbar icon before pasting my text
(and none of my actual clients would ever think of doing that either), I came
up with a very simple plugin to do the boring stuff for me.</p>

<h2>The plugin</h2>

<p>The only goal of this plugin is setting to <code>true</code>the <code>pasteAsPlainText
</code>property of every editor. This property is defaulted to <code>false</code>but can be
swapped using the toolbar icon.</p>

<p>I also forced the <code>paste_text_sticky</code> setting to <code>true</code>, preventing the
previous property to revert to <code>false</code>after the first pasting.</p>

<p>Here&#39;s my plugin full code :</p>

<p>Be sure to include the <code>paste</code>plugin in your plugin list, and insert my
plugin *<em>after *</em>the paste plugin.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="cm">/**</span>
<span class="cm"> *    Will automatically convert pasted text so no junk code will be included.</span>
<span class="cm"> *    This plugin depends on the core paste plugin.</span>
<span class="cm"> **/</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">tinymce</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;tinymce.plugins.pasteAsPlainTextPlugin&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">init</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">editor</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// We force the pasting to occur as plain text</span>
      <span class="nx">editor</span><span class="p">.</span><span class="nx">pasteAsPlainText</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// We also put it as sticky to allow for multiple pastings</span>
      <span class="nx">editor</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">paste_text_sticky</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="c1">// Adding some special post process</span>
      <span class="nx">editor</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">paste_postprocess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
          <span class="nx">split</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">+</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="p">;</span>

        <span class="c1">// If content is long text without HTML, We&#39;ll break it into &lt;p&gt;ieces</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;&lt;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">split</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Adding &lt;p&gt; around each line</span>
          <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">),</span>
            <span class="nx">sentences</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">split</span><span class="p">)</span>
          <span class="p">;</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">max</span><span class="o">=</span><span class="nx">sentences</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">!=</span><span class="nx">max</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">+=</span><span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">+</span><span class="nx">sentences</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="c1">// Saving back in original content/node</span>
          <span class="nx">o</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
          <span class="nx">o</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Register plugin</span>
  <span class="nx">tinymce</span><span class="p">.</span><span class="nx">PluginManager</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;pasteAsPlainText&#39;</span><span class="p">,</span> <span class="nx">tinymce</span><span class="p">.</span><span class="nx">plugins</span><span class="p">[</span><span class="nx">pasteAsPlainTextPlugin</span><span class="p">]);</span>
<span class="p">})();</span>
</code></pre></div>
<h2>Update</h2>

<p>I added a <code>postprocess</code>calback after seing that the pasted text was a little
too plain in Webkit. All my text was displayed on the same line, without the
nice breaking into paragraph that Firefox showed.</p>

<p>It occured because tinyMCE used the <code>event.clipboardData</code> property that Webkit
browsers provides and allow for easy retrieving of clipboard data.
Unfortunatly it returned a really plain text, and I had to apply a little loop
to replace each new line with a paragraph.</p>


    <div class="tag-list">
      
        <a href="/tags/word">#word</a>
      
        <a href="/tags/tinymce">#tinymce</a>
      
        <a href="/tags/javascript">#javascript</a>
      
        <a href="/tags/copy-paste">#copy-paste</a>
      
    </div>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page25">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page23">Newer</a>
    
  
</div>

  </div>

</body>

</html>
