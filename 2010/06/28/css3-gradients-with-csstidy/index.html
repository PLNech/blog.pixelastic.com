<!doctype html>
<html class="no-js" lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>
     CSS3 gradients with CSSTidy - Pixelastic 
  </title>
  <meta name="description" content="Personal blog of Tim Carry. Posting mostly on tech-related stuff.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/forms.css">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

<body class="layout-reverse theme-base-0b">
  <div class="sidebar">
    <div class="container">
      <div class="sidebar-about">
        <h1><a href="/index.html">Pixelastic</a></h1>
        <p class="lead">Personal blog of Tim Carry. Posting mostly on tech-related stuff.</p>
      </div>

      <ul class="sidebar-nav">
        <li class="sidebar-nav-item">
          <a href="/">Home</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/about/">About</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/archive/">Archive</a>
        </li>
      </ul>
      <div class="sidebar-footer">Website code available on <a href="https://github.com/pixelastic/blog.pixelastic.com">GitHub</a></div>
    </div>
  </div>

  <div class="content container">
    <div class="post">
  <h1 class="post-title">CSS3 gradients with CSSTidy</h1>
  <span class="post-date">28 Jun 2010</span>
  <p>Gradients are one of the new cool stuff CSS3 brought with it. Like the others
cool things, it still suffer from a partial implementation and vendor-specific
properties.</p>

<p>It also isn&#39;t correctly parsed by CSSTidy. Here I&#39;ll show you how to patch
your CSSTidy to make it eat gradients correctly.</p>

<h2>Quick and dirty patch</h2>

<p>First, you&#39;ll need to edit the huge <code>parse()</code> method in c<code>sstidy.ph</code>p. You&#39;ll
have to add a condition to explictly tell CSSTidy not to discard <code>-webkit-
gradient</code> and <code>-moz-linear-gradient</code>.</p>

<p>Just open your <code>csstidy.php</code> file, find the <code>parse()</code> method and locate the
<code>case &#39;instr&#39;</code> in the huge <code>switch</code>statement.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if (!($this-&gt;str_char === &#39;)&#39; &amp;&amp; in_array($string{$i}, $GLOBALS[&#39;csstidy&#39;][&#39;whitespace&#39;]) &amp;&amp; !$this-&gt;str_in_str)) {</span>
<span class="x">  $this-&gt;cur_string .= $temp_add;</span>
<span class="x">} **else {**</span>
<span class="x">**  if ($this-&gt;sub_value==&quot;-webkit-gradient&quot; || $this-&gt;sub_value==&quot;-moz-linear-gradient&quot;) {**</span>
<span class="x">**      $this-&gt;cur_string.=&#39; &#39;;**</span>
<span class="x">**  }**</span>
<span class="x">**}**</span>
</code></pre></div>
<p>In bold, the <code>else</code>part to add. This will make sure your webkit and firefox
gradient rules will get processed correctly.</p>

<p>I don&#39;t really understand WHY it work, but it does. The <code>parse()</code>method is a
huge uncommented mess, it is quite difficult to understand it. There must be a
better way, a more generic one than specifying some properties, but I didn&#39;t
manage to come with anything better than that.</p>

<p>Fortunatly, the next part is cleaner.</p>

<h2>Telling CSSTidy which properties not to merge</h2>

<p>If you write a css like the following, only the latest (<code>color:white</code>) rule
will get through CSSTidy.</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">body</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span><span class="nb">red</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span><span class="nb">white</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>That&#39;s logical, because CSSTidy will remove any unused CSS declaration.
Unfortunatly, this is not what we want, because we need to declare several
<code>background:</code> rules, one for Webkit, and one for Firefox.</p>

<p>By looking at CSSTidy source code, we can find that it contain a quick fix to
allow the <code>cursor:</code> property to be defined several time (to cope with the old
<code>cursor:pointer</code> / <code>cursor:hand</code> issue).</p>

<p>I just extended this quick fix to work for other properties as well, and even
managed to allow them to be passed as a config value.</p>

<h2>Defining the config value</h2>

<p>First, open the <code>csstidy.php</code> file, and around line 310 you should find a list
of default config values. Just add the following :</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$this-&gt;settings[&#39;multiple_properties&#39;] = array(&#39;cursor&#39;, &#39;background&#39;);</span>
</code></pre></div>
<p>This will define the default list of properties that are allowed to be defined
several times in a css rule.</p>

<p>Next, we&#39;ll edit the <code>set_cfg()</code> method to allow the passing of array values.
Just replace the else statement with this one :</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">else</span> <span class="nt">if</span><span class="o">(</span><span class="nt">isset</span><span class="o">(</span><span class="err">$</span><span class="nt">this-</span><span class="o">&gt;</span><span class="nt">settings</span><span class="o">[</span><span class="err">$</span><span class="nt">setting</span><span class="o">])</span> <span class="o">&amp;&amp;</span> <span class="err">$</span><span class="nt">value</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Merging</span> <span class="n">array</span> <span class="n">settings</span>
  <span class="n">if</span> <span class="p">(</span><span class="n">is_array</span><span class="p">(</span><span class="err">$</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_array</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]))</span> <span class="err">{</span>
    <span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_merge</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]</span><span class="o">,</span> <span class="err">$</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span> <span class="nt">else</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Setting</span> <span class="n">classic</span> <span class="n">setting</span>
  <span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">if</span> <span class="o">(</span><span class="err">$</span><span class="nt">setting</span> <span class="o">===</span> <span class="s1">&#39;template&#39;</span><span class="o">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_load_template</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="nt">return</span> <span class="nt">true</span><span class="o">;</span>
<span class="err">}</span>
</code></pre></div>
<p>You can now pass a list of properties to be added to the existing list by
calling <code>-&gt;set_cfg(&#39;multiple_properties&#39;, array(&#39;property1&#39;, &#39;property2&#39;));</code></p>

<p>Now, find the <code>css_add_property(</code>) method, and around line 1066, change the<code>
if (strtolower($property) == &#39;cursor&#39;)</code>if statement to this more generic one
:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if (in_array($property, $this-&gt;get_cfg(&#39;multiple_properties&#39;)))</span>
</code></pre></div>
<p>And now, in <code>csstidy_print.php</code>, find the<code>_print()</code> method, and replace the
<code>case PROPERTY</code> block with this (more concise) one :</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">case PROPERTY:</span>
<span class="x">  // Converting back multiple properties</span>
<span class="x">  $multipleProperties = $this-&gt;parser-&gt;get_cfg(&#39;multiple_properties&#39;);</span>
<span class="x">  foreach($multipleProperties as $property) {</span>
<span class="x">    $propertyLength = strlen($property);</span>
<span class="x">    if (substr($token[1], 0, $propertyLength)==$property) $token[1] = $property;</span>
<span class="x">  }</span>


<span class="x">  // Applying correct casing</span>
<span class="x">  $caseProperties = $this-&gt;parser-&gt;get_cfg(&#39;case_properties&#39;);</span>
<span class="x">  if ($caseProperties==2) $token[1] = strtoupper($token[1]);</span>
<span class="x">  if ($caseProperties==1) $token[1] = strtolower($token[1]);</span>

<span class="x">  $out .= $template[4] . $this-&gt;_htmlsp($token[1], $plain) . &#39;:&#39; . $template[5];</span>
<span class="x">break;</span>
</code></pre></div>
<h2>And that&#39;s it</h2>

<p>You now can have gradients compressed with CSSTidy. Well sort of, because this
is just a quick and dirty patch, as I&#39;m not the creator of CSSTidy.</p>

<p>This could surely be improved in a less hacky way, for example by compressing
the color code used in the gradients...</p>

  <div class="tag-list">
    
      <a href="/tags/gradients">#gradients</a>
    
      <a href="/tags/csstidy">#csstidy</a>
    
      <a href="/tags/css3">#css3</a>
    
      <a href="/tags/css">#css</a>
    
  </div>
</div>

<!-- <div class="related"> -->
<!--   <h2>Related Posts</h2> -->
<!--   <ul class="related-posts"> -->
<!--      -->
<!--       <li> -->
<!--         <h3> -->
<!--           <a href="/2014/01/07/utf-8-encoding-included-jsp-files/"> -->
<!--             UTF-8 encoding for included .jsp files -->
<!--             <small>07 Jan 2014</small> -->
<!--           </a> -->
<!--         </h3> -->
<!--       </li> -->
<!--      -->
<!--       <li> -->
<!--         <h3> -->
<!--           <a href="/2013/09/27/understanding-nginx-location-blocks-rewrite-rules/"> -->
<!--             Understanding nginx location blocks and rewrite rules -->
<!--             <small>27 Sep 2013</small> -->
<!--           </a> -->
<!--         </h3> -->
<!--       </li> -->
<!--      -->
<!--       <li> -->
<!--         <h3> -->
<!--           <a href="/2013/09/09/telecharger-parisweb-2012-sous-forme-de-podcasts/"> -->
<!--             Télécharger ParisWeb 2012 sous forme de podcasts -->
<!--             <small>09 Sep 2013</small> -->
<!--           </a> -->
<!--         </h3> -->
<!--       </li> -->
<!--      -->
<!--   </ul> -->
<!-- </div> -->

  </div>

</body>

</html>
