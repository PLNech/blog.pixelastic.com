<!doctype html>
<html class="no-js" lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>
     Memcache keys not getting saved correctly - Pixelastic 
  </title>
  <meta name="description" content="Personal blog of Tim Carry. Posting mostly on tech-related stuff.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/forms.css">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

<body class="layout-reverse theme-base-0b">
  <div class="sidebar">
    <div class="container">
      <div class="sidebar-about">
        <h1><a href="/index.html">Pixelastic</a></h1>
        <p class="lead">Personal blog of Tim Carry. Posting mostly on tech-related stuff.</p>
      </div>

      <ul class="sidebar-nav">
        <li class="sidebar-nav-item">
          <a href="/">Home</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/about/">About</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/archive/">Archive</a>
        </li>
      </ul>
      <div class="sidebar-footer">Website code available on <a href="https://github.com/pixelastic/blog.pixelastic.com">GitHub</a></div>
    </div>
  </div>

  <div class="content container">
    <div class="post">
  <h1 class="post-title">Memcache keys not getting saved correctly</h1>
  <span class="post-date">08 Apr 2011</span>
  <p><em>Update : We were initially blaming Memcache not correctly setting/getting
keys. We should instead have blamed him for being over-zealous in clearing its
list. See bottom of post for details.</em></p>

<p>Today we were having a bit of an issue with memcache. We had to write a
thousand keys into it, reading them from a JSON file.</p>

<p>This code had been running happily on our server for the past two weeks. But
as the number of keys increased, we came to spot that some keys seemed to be
randomly cleared.</p>

<p>After further investigation (and a lot of hours), it appears that the keys
were simply not set at all, or set to an empty/false value. This was really
strange because it occured inside a loop on our JSON file, and never occurs
for the same keys, nor everytime.</p>

<p>We took our server under high stress, forcing it to reload data very often, to
trigger the bug once more. After a lot of test, we gather some more data, but
nothing really came out. The missed keys were really random.</p>

<p>Finally, we decided to code a fast and dirty fix, until we found a better
solution. Basically, we simply checks that the value is correctly saved after
saving it, and if not, we retry. And we do so recursively.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">function set($key, $val, $recursionLevel = 0) {</span>
<span class="x">  Cache::write($key, $val);</span>
<span class="x">  if (Cache::read($key)===false) {</span>
<span class="x">    if ($recursionLevel&gt;10) die(&#39;Possible infinite recursion);</span>
<span class="x">    $this-&gt;set($key, $val, $recursionLevel);</span>
<span class="x">  }</span>
<span class="x">}</span>
</code></pre></div>
<p>Note, that this will not work if one of your values is defined as false,
otherwise you&#39;ll end up in an infinite loop.</p>

<h2>Update</h2>

<p>Well, the problem kept sporadically popping. And we finally found the REAL
culprit.</p>

<p>Cake provides multiple <code>Cache</code>config, using different settings. One would use
a special config to set different cache duration. Each setting would use a
different key prefix.</p>

<p>Unfortunatly, memcache has no way of finding keys starting with a special
prefix. So when we do a <code>Cache::clear()</code>, it just wipes clear the whole
memcache keys, no matter what config you specify.</p>

<p>We were running two different websites using the same memcache server, and
when doing a clear on one website, it cleared keys on the second one as well.</p>

<p>We finally started one memcache server per site.</p>

  <div class="tag-list">
    
      <a href="/tags/memcached">#memcached</a>
    
      <a href="/tags/php">#php</a>
    
      <a href="/tags/cakephp">#cakephp</a>
    
  </div>
</div>

<!-- <div class="related"> -->
<!--   <h2>Related Posts</h2> -->
<!--   <ul class="related-posts"> -->
<!--      -->
<!--       <li> -->
<!--         <h3> -->
<!--           <a href="/2014/01/07/utf-8-encoding-included-jsp-files/"> -->
<!--             UTF-8 encoding for included .jsp files -->
<!--             <small>07 Jan 2014</small> -->
<!--           </a> -->
<!--         </h3> -->
<!--       </li> -->
<!--      -->
<!--       <li> -->
<!--         <h3> -->
<!--           <a href="/2013/09/27/understanding-nginx-location-blocks-rewrite-rules/"> -->
<!--             Understanding nginx location blocks and rewrite rules -->
<!--             <small>27 Sep 2013</small> -->
<!--           </a> -->
<!--         </h3> -->
<!--       </li> -->
<!--      -->
<!--       <li> -->
<!--         <h3> -->
<!--           <a href="/2013/09/09/telecharger-parisweb-2012-sous-forme-de-podcasts/"> -->
<!--             Télécharger ParisWeb 2012 sous forme de podcasts -->
<!--             <small>09 Sep 2013</small> -->
<!--           </a> -->
<!--         </h3> -->
<!--       </li> -->
<!--      -->
<!--   </ul> -->
<!-- </div> -->

  </div>

</body>

</html>
