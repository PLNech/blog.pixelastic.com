<!doctype html>
<html class="no-js" lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>
     Pixelastic 
  </title>
  <meta name="description" content="Personal blog of Tim Carry. Posting mostly on tech-related stuff.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/forms.css">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

<body class="layout-reverse theme-base-0b">
  <div class="sidebar">
    <div class="container">
      <div class="sidebar-about">
        <h1><a href="/index.html">Pixelastic</a></h1>
        <p class="lead">Personal blog of Tim Carry. Posting mostly on tech-related stuff.</p>
      </div>

      <ul class="sidebar-nav">
        <li class="sidebar-nav-item active">
          <a href="/">Home</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/about/">About</a>
        </li>
        <li class="sidebar-nav-item">
          <a href="/archive/">Archive</a>
        </li>
      </ul>
      <div class="sidebar-footer">Website code available on <a href="https://github.com/pixelastic/blog.pixelastic.com">GitHub</a></div>
    </div>
  </div>

  <div class="content container">
    <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/07/05/displaying-a-date-in-the-correct-locale-with-cakephp/">
        Displaying a date in the correct locale with cakePHP
      </a>
    </h1>

    <span class="post-date">05 Jul 2010</span>

    <p>The easiest way to display a date in a given format is to use a combination of
<code>strftime()</code> and <code>strtotime()</code>.</p>

<p>Sometimes, you also need your date to be displayed in a specific language. For
example, for a french website, I needed a date to be displayed as &quot;<em>mardi 03
août 2010</em>&quot; instead of &quot;<em>Wednesday, August 3rd</em>&quot;.</p>

<h2>Setting the locale</h2>

<p>To achieve that, you just have to tell PHP which locale to use when displaying
date with <code>setlocale(LC_TIME, $locale)</code>.</p>

<p>The value of <code>$locale</code> is OS dependent, though. For example, on a linux
server, you have to set <code>fr_FR</code> while it is <code>fr</code> or even <code>french</code>on Windows.</p>

<p>Fortunatly, you can pass an array of locales to <code>setlocale</code>(, and the system
will use the first one it can find. You just have to pass an array containing
all possible values and you&#39;ll be good to go.</p>

<p>I wrote a little method that use the <code>L10n</code>object that comes with cakePHP to
automate the creation of such an array. Just feed him a 3-letter language code
and it will return an array of the most common locale names.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">function getLocales($lang) {</span>
<span class="x">// Loading the L10n object</span>
<span class="x">App::import(&#39;L10n&#39;);</span>
<span class="x">$l10n = new L10n();</span>

<span class="x">// Iso2 lang code</span>
<span class="x">$iso2 = $l10n-&gt;map($lang);</span>
<span class="x">$catalog = $l10n-&gt;catalog($lang);</span>

<span class="x">$locales = array(</span>
<span class="x">  $iso2.&#39;_&#39;.strtoupper($iso2).&#39;.&#39;.strtoupper(str_replace(&#39;-&#39;, &#39;&#39;, $catalog[&#39;charset&#39;])),    // fr_FR.UTF8</span>
<span class="x">  $iso2.&#39;_&#39;.strtoupper($iso2),    // fr_FR</span>
<span class="x">  $catalog[&#39;locale&#39;],             // fre</span>
<span class="x">  $catalog[&#39;localeFallback&#39;],     // fre</span>
<span class="x">  $iso2                           // fr</span>
<span class="x">  );</span>
<span class="x">return $locales;</span>
<span class="x">}</span>
</code></pre></div>
<p>You may note that I set in first position a locale with the mention of the
encoding. This is only used on Linux machines, Windows does not handle that.
That&#39;s a pity, but I&#39;ll show you how to correctly make it work underWwindows.</p>

<p>As a side note, <code>setlocale</code> will not <code>return false</code> if the locale is not
found, it will just fail to load it.</p>

<h2>Displaying date in UTF8</h2>

<p>If your app is in UTF8 (and it should be !) you may run into problem when
trying to display a simple <code>strftime(&quot;%B&quot;, strtotime($date))</code> on Windows.</p>

<p><code>%B</code> translate to the current month name. For a month like <em>Août</em> (<em>August</em>)
the funny <em>û</em> will not get correctly displayed, because Windows does its
locale translation in its native encoding.</p>

<p>You&#39;ll need to manually encode it in utf8, but if you do so on a linux
machine, as the result is already encoded in utf8 you may end in double
encoding the same string, resulting in others display errors.</p>

<p>Note also that if your format string itself contains utf8 encoded characters
(like<code>%A %d %B %Y à %Hh%M</code>), encoding it in utf8 again will also result in
wrong characters displayed.</p>

<p>What I&#39;ve done is creating a simple method in an helper that will take care of
encoding the result if needed.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">function time($format, $date = null) {</span>
<span class="x">  // On Windows, we will force the utf8 encoding of the date</span>
<span class="x">  if (DIRECTORY_SEPARATOR == &#39;\\&#39;) {</span>
<span class="x">    return utf8_encode(strftime(utf8_decode($format), strtotime($date)));</span>
<span class="x">  }</span>
<span class="x">  // On linux, this is already taken care of by setlocale()</span>
<span class="x">  return strftime($format, strtotime($date));</span>
<span class="x">}</span>
</code></pre></div>
<p>This way, we make sure that the date is correctly displayed in utf8, no matter
the OS, even if you already supply utf8 characters in the format string.</p>


    <div class="tag-list">
      
        <a href="/tags/utf8">#utf8</a>
      
        <a href="/tags/cakephp">#cakephp</a>
      
        <a href="/tags/i18n">#i18n</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/06/30/breaking-out-of-an-if-statement-in-php/">
        Breaking out of an if statement in PHP
      </a>
    </h1>

    <span class="post-date">30 Jun 2010</span>

    <p>One pattern I use when writing new method is to put conditions that may end
the script early on top. Like &quot;stop the method if the arguments are not right&quot;
or &quot;stop the action if the user is not loggued in&quot;.</p>

<p>It allow me to avoid having nested <code>if</code>/<code>else</code>statement that became
unreadable.</p>

<p>Felix from Debuggable wrote <a href="http://debuggable.com/posts/programming-psychology-return-home-early%0A:4811de9f-ae28-49c2-a7dc-2f154834cda3">something about that a while
ago.</a></p>

<p>This is a pretty easy pattern to follow when writing methods, but can be quite
harder to achieve if you need to stick inside a main method. You just want to
go &quot;out&quot; of the <code>if</code> statement, to continue the script, but not end the
method.</p>

<h2>Break to the rescue</h2>

<p>You can&#39;t use the <code>break</code>keyword in an <code>if</code> statement like you would in a
loop. It just throws an error.</p>

<p>But, you can define a simple <code>do {} while (false)</code> loop and use the break
goodness inside it.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">do {</span>
<span class="x">  if (empty($data)) break;</span>
<span class="x">                 </span>
<span class="x">  $this-&gt;create($data);</span>
<span class="x">                   </span>
<span class="x">  if (!$this-&gt;validates()) break;</span>
<span class="x">                   </span>
<span class="x">  $this-&gt;save();</span>
<span class="x">} while (false);</span>
</code></pre></div>
<p>This helped me some times, hope it can help someone else.</p>


    <div class="tag-list">
      
        <a href="/tags/php">#php</a>
      
        <a href="/tags/break">#break</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/06/28/css3-gradients-with-csstidy/">
        CSS3 gradients with CSSTidy
      </a>
    </h1>

    <span class="post-date">28 Jun 2010</span>

    <p>Gradients are one of the new cool stuff CSS3 brought with it. Like the others
cool things, it still suffer from a partial implementation and vendor-specific
properties.</p>

<p>It also isn&#39;t correctly parsed by CSSTidy. Here I&#39;ll show you how to patch
your CSSTidy to make it eat gradients correctly.</p>

<h2>Quick and dirty patch</h2>

<p>First, you&#39;ll need to edit the huge <code>parse()</code> method in c<code>sstidy.ph</code>p. You&#39;ll
have to add a condition to explictly tell CSSTidy not to discard <code>-webkit-
gradient</code> and <code>-moz-linear-gradient</code>.</p>

<p>Just open your <code>csstidy.php</code> file, find the <code>parse()</code> method and locate the
<code>case &#39;instr&#39;</code> in the huge <code>switch</code>statement.</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if (!($this-&gt;str_char === &#39;)&#39; &amp;&amp; in_array($string{$i}, $GLOBALS[&#39;csstidy&#39;][&#39;whitespace&#39;]) &amp;&amp; !$this-&gt;str_in_str)) {</span>
<span class="x">  $this-&gt;cur_string .= $temp_add;</span>
<span class="x">} **else {**</span>
<span class="x">**  if ($this-&gt;sub_value==&quot;-webkit-gradient&quot; || $this-&gt;sub_value==&quot;-moz-linear-gradient&quot;) {**</span>
<span class="x">**      $this-&gt;cur_string.=&#39; &#39;;**</span>
<span class="x">**  }**</span>
<span class="x">**}**</span>
</code></pre></div>
<p>In bold, the <code>else</code>part to add. This will make sure your webkit and firefox
gradient rules will get processed correctly.</p>

<p>I don&#39;t really understand WHY it work, but it does. The <code>parse()</code>method is a
huge uncommented mess, it is quite difficult to understand it. There must be a
better way, a more generic one than specifying some properties, but I didn&#39;t
manage to come with anything better than that.</p>

<p>Fortunatly, the next part is cleaner.</p>

<h2>Telling CSSTidy which properties not to merge</h2>

<p>If you write a css like the following, only the latest (<code>color:white</code>) rule
will get through CSSTidy.</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">body</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span><span class="nb">red</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span><span class="nb">white</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>That&#39;s logical, because CSSTidy will remove any unused CSS declaration.
Unfortunatly, this is not what we want, because we need to declare several
<code>background:</code> rules, one for Webkit, and one for Firefox.</p>

<p>By looking at CSSTidy source code, we can find that it contain a quick fix to
allow the <code>cursor:</code> property to be defined several time (to cope with the old
<code>cursor:pointer</code> / <code>cursor:hand</code> issue).</p>

<p>I just extended this quick fix to work for other properties as well, and even
managed to allow them to be passed as a config value.</p>

<h2>Defining the config value</h2>

<p>First, open the <code>csstidy.php</code> file, and around line 310 you should find a list
of default config values. Just add the following :</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$this-&gt;settings[&#39;multiple_properties&#39;] = array(&#39;cursor&#39;, &#39;background&#39;);</span>
</code></pre></div>
<p>This will define the default list of properties that are allowed to be defined
several times in a css rule.</p>

<p>Next, we&#39;ll edit the <code>set_cfg()</code> method to allow the passing of array values.
Just replace the else statement with this one :</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span class="nt">else</span> <span class="nt">if</span><span class="o">(</span><span class="nt">isset</span><span class="o">(</span><span class="err">$</span><span class="nt">this-</span><span class="o">&gt;</span><span class="nt">settings</span><span class="o">[</span><span class="err">$</span><span class="nt">setting</span><span class="o">])</span> <span class="o">&amp;&amp;</span> <span class="err">$</span><span class="nt">value</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Merging</span> <span class="n">array</span> <span class="n">settings</span>
  <span class="n">if</span> <span class="p">(</span><span class="n">is_array</span><span class="p">(</span><span class="err">$</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_array</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]))</span> <span class="err">{</span>
    <span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_merge</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]</span><span class="o">,</span> <span class="err">$</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span> <span class="nt">else</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Setting</span> <span class="n">classic</span> <span class="n">setting</span>
  <span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="err">$</span><span class="n">setting</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">if</span> <span class="o">(</span><span class="err">$</span><span class="nt">setting</span> <span class="o">===</span> <span class="s1">&#39;template&#39;</span><span class="o">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_load_template</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="nt">return</span> <span class="nt">true</span><span class="o">;</span>
<span class="err">}</span>
</code></pre></div>
<p>You can now pass a list of properties to be added to the existing list by
calling <code>-&gt;set_cfg(&#39;multiple_properties&#39;, array(&#39;property1&#39;, &#39;property2&#39;));</code></p>

<p>Now, find the <code>css_add_property(</code>) method, and around line 1066, change the<code>
if (strtolower($property) == &#39;cursor&#39;)</code>if statement to this more generic one
:</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if (in_array($property, $this-&gt;get_cfg(&#39;multiple_properties&#39;)))</span>
</code></pre></div>
<p>And now, in <code>csstidy_print.php</code>, find the<code>_print()</code> method, and replace the
<code>case PROPERTY</code> block with this (more concise) one :</p>
<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">case PROPERTY:</span>
<span class="x">  // Converting back multiple properties</span>
<span class="x">  $multipleProperties = $this-&gt;parser-&gt;get_cfg(&#39;multiple_properties&#39;);</span>
<span class="x">  foreach($multipleProperties as $property) {</span>
<span class="x">    $propertyLength = strlen($property);</span>
<span class="x">    if (substr($token[1], 0, $propertyLength)==$property) $token[1] = $property;</span>
<span class="x">  }</span>


<span class="x">  // Applying correct casing</span>
<span class="x">  $caseProperties = $this-&gt;parser-&gt;get_cfg(&#39;case_properties&#39;);</span>
<span class="x">  if ($caseProperties==2) $token[1] = strtoupper($token[1]);</span>
<span class="x">  if ($caseProperties==1) $token[1] = strtolower($token[1]);</span>

<span class="x">  $out .= $template[4] . $this-&gt;_htmlsp($token[1], $plain) . &#39;:&#39; . $template[5];</span>
<span class="x">break;</span>
</code></pre></div>
<h2>And that&#39;s it</h2>

<p>You now can have gradients compressed with CSSTidy. Well sort of, because this
is just a quick and dirty patch, as I&#39;m not the creator of CSSTidy.</p>

<p>This could surely be improved in a less hacky way, for example by compressing
the color code used in the gradients...</p>


    <div class="tag-list">
      
        <a href="/tags/gradients">#gradients</a>
      
        <a href="/tags/csstidy">#csstidy</a>
      
        <a href="/tags/css3">#css3</a>
      
        <a href="/tags/css">#css</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/06/25/meeting-with-eric-daspet-and-stoyan-stefanov-in-paris/">
        Meeting with Eric Daspet and Stoyan Stefanov in Paris
      </a>
    </h1>

    <span class="post-date">25 Jun 2010</span>

    <p>On July 21st will be held an <a href="https://sites.google.com/a/survol.fr/webperf-user-%0Agroup/evenements/21-juillet-2010">informal meeting in
Paris</a> for all the web developers that have an
interest in web performance.</p>

<p><a href="http://performance.survol.fr/">Eric Daspet</a> and <a href="http://www.phpied.com/">Stoyan
Stefanov</a> will be there and host a talk about
performance impact on sales and some more technical less known facts.</p>

<p>The first part will be in French while Stoyan&#39;s will be in English. If you
have the chance to be in Paris in July, do not miss this event.</p>

<p>I will, of course, be there. Eric Daspet is the french &quot;gourou&quot; on web
performances, and Stoyan Stefanov is one of the main author of the Smushit
plugin/websit.</p>

<p>Web performance is a really interesting subject where there is so much to
learn and so much to try.</p>


    <div class="tag-list">
      
        <a href="/tags/stoyan-stefanov">#stoyan-stefanov</a>
      
        <a href="/tags/smushit">#smushit</a>
      
        <a href="/tags/performance">#performance</a>
      
        <a href="/tags/eric-daspet">#eric-daspet</a>
      
    </div>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2010/06/14/improved-form-spam-protection/">
        Improved form spam protection
      </a>
    </h1>

    <span class="post-date">14 Jun 2010</span>

    <p>My spam protection is really simple. Most spam bots will fill all input fields
they&#39;ll find in a form. If one is named website or email, they will most
certainly want to fill them first.</p>

<p>So I&#39;ve added to every form a fake input field with a <code>name=&quot;email&quot;</code>that have
to stay empty. I also labeled it &quot;Spam bait&quot; and displayed a little sentence
to tell my human readers to keep this field empty.</p>

<p>I also hide the whole field using Javascript because most of the bots don&#39;t
have Javascript enabled, but legitimate users do.</p>

<h2>Does it work ?</h2>

<p>To say the truth I don&#39;t know. In the previous version of this website I
haven&#39;t any kind of spam protection and was receinving almost a dozen spam
mails a day.</p>

<p>Now that I&#39;ve added this protection, I don&#39;t receive spam anymore. But that
doesn&#39;t mean my protection is working, it may just mean that the spam bots
needs a little time to adjust to the new website.</p>

<h2>Improving the existing</h2>

<p>One week ago, two spam comments managed to get past my protection. I have
currently no way to judge my protection efficiency. Maybe that was the only
two spam comments aimed at my website and I let them both slip in. Maybe I was
under a mass attack and managed to block thousand of spam and those two were
the only two to beat me.</p>

<p>I don&#39;t know, I have absolutly no numbers on that.</p>

<h2>Getting some stats</h2>

<p>So today, I decided to add some extra measures. I&#39;m keeping count of every
spam I block (this number will be displayed below the comment list if at least
one spam was blocked).</p>

<p>I&#39;ll also log some informations when someone is posting a comment : headers
sent, if javascript is enabled and the delay between displaying the form and
submitting it.</p>

<p>It is useless to build protection if you don&#39;t know what you want to be
protected against. So I&#39;ll let the actual protection in place and will come
back to check the numbers in a couple of weeks.</p>

<p>I&#39;ll then know exactly how performs my existing spam protection and will be
able to extract spam patterns from the information I&#39;ll gather.</p>

<p>I think I&#39;ll add a timing system, to block comments that were posted too fast.
If nothing works I&#39;ll use Akismet, but I want to try to defeat them on my own
first.</p>


    <div class="tag-list">
      
        <a href="/tags/spam">#spam</a>
      
        <a href="/tags/akismet">#akismet</a>
      
    </div>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page31">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page29">Newer</a>
    
  
</div>

  </div>

</body>

</html>
